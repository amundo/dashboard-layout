<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Wikipedia: Esperanto</title>
  <link rel="icon"
    href="data:image/svg+xml,%3Csvg%20xmlns%3D'http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg'%20width%3D'48'%20height%3D'48'%20viewBox%3D'0%200%2016%2016'%3E%3Ctext%20x%3D'0'%20y%3D'14'%3E%F0%9F%93%90%3C%2Ftext%3E%3C%2Fsvg%3E" />
  <style>
* { box-sizing: border-box; margin: 0; }

html, body  { height: 100%; }
aside, main { overflow-y: scroll; }

body {
  display: grid;
  background: hsl(205.3, 100%, 70.3%);
  padding: 1em;
  > * {
    padding: 1em;
    background: hsl(0, 0%, 100%);
  }
  gap: 1em;
  grid-template: 
    "header header" auto 
    "aside  main"   1fr 
    "footer footer" auto 
  /  1fr    3fr;

  header, footer {
    grid-column: span 2;
  }
}

form#fetch-article { display: inline;}
  </style>
</head>

<body>
  <header><h1></h1>
  </header>
  <aside>
    <h2>Table of Contents</h2>
    <ol></ol>
  </aside>
  <main><!-- content will be inserted here --> </main>
  <footer></footer>


  
<script type="module">
  // Fetch data from a given Wikipedia API URL
  const fetchWikipediaArticle = async (url) => {
    try {
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`Error fetching article: ${response.status}`);
      }
      const data = await response.json();

      if (data.parse) {
        return {
          title: data.parse.title,
          html: data.parse.text["*"]
        };
      } else {
        throw new Error("Unexpected response format");
      }
    } catch (error) {
      console.error("Error fetching Wikipedia article:", error);
    }
  };


  // Fetch a random article and return its content
  const fetchRandomWikipediaArticle = async () => {
    try {
      const randomUrl =  `https://en.wikipedia.org/w/api.php?action=query&list=random&rnnamespace=0&format=json&origin=*`
      const randomResponse = await fetch(randomUrl);
      const randomData = await randomResponse.json();
      const randomTitle = randomData.query.random[0].title

      // Use fetchWikipediaArticle to get the random article's content
      const articleUrl = `https://en.wikipedia.org/w/api.php?action=parse&page=${encodeURIComponent(randomTitle)}&format=json&origin=*`;
      return await fetchWikipediaArticle(articleUrl);
    } catch (error) {
      console.error("Error fetching random Wikipedia article:", error);
    }
  };

  // Render article content and update UI
  const renderArticle = ({ title, html }) => {
    main.innerHTML = '';
    aside.querySelector('ol').innerHTML = '';

    const articleDom = new DOMParser().parseFromString(html, 'text/html');
    const articleBody = articleDom.querySelector('body');
    const articleContents = Array.from(articleBody.children);

    header.querySelector('h1').textContent = title;

    const slugTitle = titleToSlug(title);
    footer.innerHTML = `This page is loading the content of the Wikipedia article <a href="https://en.wikipedia.org/wiki/${slugTitle}" target="_blank">${slugTitle}</a>. You can also tell it to load a <form id=fetch-article><input name="article-title" placeholder="â€¦specific article title"><button type=submit id="load-article">Load</button></form>.`



    articleContents.forEach(node => main.appendChild(node));

    main.querySelectorAll('h2, h3, h4').forEach(h => {
      const id = h.textContent.toLowerCase().replace(/\s+/g, '-');
      h.id = id;

      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = `#${id}`;
      a.textContent = h.textContent;
      li.appendChild(a);

      aside.querySelector('ol').appendChild(li);
    });

    main.querySelectorAll('link, style').forEach(el => el.remove());
  };

  // Utility function: Convert title to URL-friendly slug
  const titleToSlug = (title) => title.replaceAll(' ', '_');

  // Initialize and load a random article on page load
  const header = document.querySelector('header');
  const aside = document.querySelector('aside');
  const main = document.querySelector('main');
  const footer = document.querySelector('footer');

  const init = async () => {
    const randomArticle = await fetchRandomWikipediaArticle();
    if (randomArticle) renderArticle(randomArticle);
  };

  // Event listener for loading a specific article
  addEventListener('submit', async (e) => {
    if (e.target.matches('#fetch-article')) {
      e.preventDefault();
      const articleTitle = e.target['article-title'].value.trim();
      if (!articleTitle) return;

      const articleUrl = `https://en.wikipedia.org/w/api.php?action=parse&page=${encodeURIComponent(articleTitle)}&format=json&origin=*`;
      const chosenArticle = await fetchWikipediaArticle(articleUrl);
      if (chosenArticle) renderArticle(chosenArticle);
    }
  })

  // focus the input field on / key
  document.addEventListener('keydown', (e) => {
    if (e.key === '/') {
      e.preventDefault()
      document.querySelector('input[name="article-title"]').focus();
    }
  });

  init();
</script>
</body>
</html>
